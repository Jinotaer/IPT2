<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<!-- For more projects: Visit codeastro.com  -->

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" sizes="32x32" href="logo1.png">
  <title>POS System</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,600" rel="stylesheet">

  <!-- Styles -->
  <style>
    html,
    body {
      background-color: #fff;
      color: #636b6f;
      font-family: 'Nunito', sans-serif;
      font-weight: 200;
      height: 100vh;
      margin: 0;
    }

    .full-height {
      height: 100vh;
    }

    .flex-center {
      align-items: center;
      display: flex;
      justify-content: center;
    }

    .position-ref {
      position: relative;
    }

    .top-right {
      position: absolute;
      right: 10px;
      top: 18px;
    }

    .content {
      text-align: center;
    }

    .title {
      font-size: 84px;
    }

    .links>a {
      color: #636b6f;
      padding: 0 25px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .1rem;
      text-decoration: none;
      text-transform: uppercase;
    }

    .m-b-md {
      margin-bottom: 30px;
    }

    .buttons a {
      display: inline-block;
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      text-transform: uppercase;
    }

    /* #dc3545  #007bff #28a745*/
    .buttons a.admin {
      background-color: #6f562b;
      /* Blue */
    }

    .buttons a.cashier {
      background-color: #6f562b;
      /* Red */
    }

    .buttons a.customer {
      background-color: #6f562b;
      /* Green */
    }

    .buttons a:hover {
      opacity: 0.8;
    }

    .logo {
      margin: 0%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .logo img {
      width: 350px;
      height: auto;
    }

    .logo div {
      margin-top: 5px;
    }
  </style>
  <style>
    @media (max-width: 768px) {
      .title {
        font-size: 48px;
      }

      .buttons a {
        padding: 10px 16px;
        font-size: 14px;
        display: grid;
      }

      .logo img {
        width: 250px;
        /* Adjust the width for smaller screens */
      }
    }

    @media (max-width: 480px) {
      .title {
        font-size: 36px;
      }

      .buttons a {
        display: grid;
        padding: 8px 12px;
        font-size: 12px;
      }

      .logo img {
        width: 200px;
        /* Adjust the width for smaller screens */
      }
    }
  </style>
</head>

<body>
  <div class="flex-center position-ref full-height">
    <div class="content">
      <div class="title m-b-md">
        <div class="logo">
          <img src="logo.png" alt="POS Logo">
          <div>BNHS INVENTORY SYSTEM</div>
        </div>
      </div>

      <div class="buttons">
        <a href="Main/admin/" class="admin">Admin Log In</a>
        <a href="Main/staff/" class="cashier">Cashier Log In</a>
        <!-- <a href="Main/customer/" class="customer">Customer Log In</a> -->
      </div>
    </div>
  </div>
</body>

</html>

<!-- <a href="#" class="mode-toggler">
          <div class="moon-sun">
            <i class="material-icons-sharp moon">dark_mode</i>
            <i class="material-icons-sharp sun">light_mode</i>
          </div>
          <h3 class="mode-text text">Dark mode</h3>
           
          <div class="toggle-switch">
            <span class="switch"></span>
          </div>
        </a> -->

/* toggle icon */
aside .sidebar .mode-toggler i {
font-size: 1.6rem;
transition: all 300ms ease;
position: absolute;
}
aside .sidebar .mode-toggler .moon-sun{
height: 50px;
width: 60px;
display: flex;
align-items: center;
}
aside .sidebar .mode-toggler i.moon {
opacity: 0;
}
aside .sidebar .mode-toggler .toggle-switch{
display: flex;
align-items: center;
justify-content: center;
height: 100%;
min-width: 60px;
}
.toggle-switch .switch{
position: relative;
height: 22px;
width: 44px;
border-radius: 25px;
background: var(--color-primary);
}
.switch::before{
content: '';
position: absolute;
height: 15px;
width: 15px;
border-radius: 50%;
top: 50%;
left: 5px;
transform: translateY(-50%);
background: var(--color-white);
cursor: pointer;
}
/* END toggle icon */



CREATE TABLE verification_codes (
id INT AUTO_INCREMENT PRIMARY KEY,
email VARCHAR(255) NOT NULL,
code VARCHAR(6) NOT NULL,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

Ensure Composer is Installed
If you don’t have Composer installed, download and install it from getcomposer.org.

Navigate to Your Project Directory
Open a terminal or command prompt and go to your project folder:
cd /path/to/your/project

Run the Composer Install Command
composer require phpmailer/phpmailer

Include PHPMailer in Your PHP Script
Add the following line at the beginning of your PHP script:
require 'vendor/autoload.php';
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;




<?php
session_start();
include('config/config.php'); // Ensure this file contains a valid $mysqli connection
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require 'assets\vendor\autoload.php'; // Adjusted path to vendor/autoload.php

// Enable error reporting for debugging
error_reporting(E_ALL);
ini_set('display_errors', 1);

if (isset($_POST['send_code'])) {
  if (empty($_POST['staff_email'])) {
    $err = "Email is required";
  } else {
    $staff_email = $_POST['staff_email'];

    // Check if the email exists in the database
    $checkQuery = "SELECT COUNT(*) FROM bnhs_staff WHERE staff_email = ?";
    $checkStmt = $mysqli->prepare($checkQuery);
    if ($checkStmt) {
      $checkStmt->bind_param('s', $staff_email);
      $checkStmt->execute();
      $checkStmt->bind_result($emailCount);
      $checkStmt->fetch();
      $checkStmt->close();

      if ($emailCount == 0) {
        $err = "Email does not exist in the database.";
      } else {
        // Generate a random verification code
        $verification_code = rand(100000, 999999);

        // Store the code in the database (optional, if needed for verification later)
        $codeQuery = "INSERT INTO verification_codes (email, code, created_at) VALUES (?, ?, NOW())";
        $codeStmt = $mysqli->prepare($codeQuery);
        if ($codeStmt) {
          $codeStmt->bind_param('ss', $staff_email, $verification_code);
          $codeStmt->execute();
        } else {
          $err = "Error: " . $mysqli->error;
        }

        // Send the code via email using PHPMailer
        $mail = new PHPMailer(true);
        try {
          // Server settings
          $mail->isSMTP();
          $mail->Host = 'smtp.gmail.com'; // Replace with your SMTP server
          $mail->SMTPAuth = true;
          $mail->Username = 'jjane0248@gmail.com'; // Replace with your SMTP username
          $mail->Password = 'cwbf hstm kdfr hxrd'; // Replace with your SMTP password
          $mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;
          $mail->Port = 587;

          // Recipients
          $mail->setFrom('no-reply@bnhs.com', 'BNHS Inventory System');
          $mail->addAddress($staff_email);

          // Content
          $mail->isHTML(true);
          $mail->Subject = 'Your Verification Code';
          $mail->Body = "Your verification code is: <b>$verification_code</b>";

          $mail->send();
          $_SESSION['verify_email'] = $staff_email; // Store for verify_code and password change
          $success = "Verification code sent successfully to $staff_email";

          header("Location: verify_code.php");
          exit;

          // If successful, store email in session and redirect
          // $_SESSION['verify_email'] = $staff_email;
          // if (isset($_SESSION['verify_email'])) {
          //   header("Location: verify_code.php");
          //   exit;
          // }

        } catch (Exception $e) {
          $err = "Failed to send the verification code. Mailer Error: {$mail->ErrorInfo}";
        }
      }
    } else {
      $err = "Error: " . $mysqli->error;
    }
  }
}
require_once('partials/_inhead.php');
?>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var dropdownElements = document.querySelectorAll('.dropdown-toggle');
    dropdownElements.forEach(function (dropdown) {
      new bootstrap.Dropdown(dropdown);
    });
  });
</script>

.buttons a {
display: inline-block;
padding: 10px 20px;
margin: 10px;
font-size: 16px;
font-weight: 600;
color: #fff;
border: none;
border-radius: 5px;
text-decoration: none;
text-transform: uppercase;
}

.buttons a.admin {
background-color: #29126b; /* Blue */
}

.buttons a.cashier {
background-color: #29126d; /* Red */
}

.buttons a.customer {
background-color: #29126d; /* Green */
}

.buttons a:hover {
opacity: 0.5;
}


body>
<div class="container">
  <div class="row">
    <div id="Receipt" class="well col-xs-10 col-sm-10 col-md-6 col-xs-offset-1 col-sm-offset-1 col-md-offset-3">
      <div class="row">
        <div class="col-xs-6 col-sm-6 col-md-6">
          <address>
            <strong>CodeAstro Lounge</strong>
            <br>
            127-0-0-1
            <br>
            4151 Willow Oaks Lane, Sugartown
            <br>
            (+000) 337-337-3069
          </address>
        </div>
        <div class="col-xs-6 col-sm-6 col-md-6 text-right">
          <p>
            <em>Date: <?php echo date('d/M/Y g:i', strtotime($order->created_at)); ?></em>
          </p>
          <p>
            <em class="text-success">Receipt #: <?php echo $order->order_code; ?></em>
          </p>
        </div>
      </div>
      <div class="row">
        <div class="text-center">
          <h2>Receipt</h2>
        </div>
        </span>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th class="text-center">Unit Price</th>
              <th class="text-center">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="col-md-9"><em> <?php echo $order->prod_name; ?> </em></h4>
              </td>
              <td class="col-md-1" style="text-align: center"> <?php echo $order->prod_qty; ?></td>
              <td class="col-md-1 text-center">$<?php echo $order->prod_price; ?></td>
              <td class="col-md-1 text-center">$<?php echo $total; ?></td>
            </tr>
            <tr>
              <td>   </td>
              <td>   </td>
              <td class="text-right">
                <p>
                  <strong>Subtotal: </strong>
                </p>
                <p>
                  <strong>Tax: </strong>
                </p>
              </td>
              <td class="text-center">
                <p>
                  <strong>$<?php echo $total; ?></strong>
                </p>
                <p>
                  <strong>14%</strong>
                </p>
              </td>
            </tr>
            <tr>
              <td>   </td>
              <td>   </td>
              <td class="text-right">
                <h4><strong>Total: </strong></h4>
              </td>
              <td class="text-center text-danger">
                <h4><strong>$<?php echo $total; ?></strong></h4>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="well col-xs-10 col-sm-10 col-md-6 col-xs-offset-1 col-sm-offset-1 col-md-offset-3">
      <button id="print" onclick="printContent('Receipt');" class="btn btn-success btn-lg text-justify btn-block">
        Print <span class="fas fa-print"></span>
      </button>
    </div>
  </div>
</div>
</body>


<?php
session_start();
include('config/config.php');
include('config/checklogin.php');
check_login();
?>
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Bukidnon National High School Inventory System</title>
  <link rel="apple-touch-icon" sizes="180x180" href="assets/img/brand/bnhs.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/img/brand/bnhs.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/img/brand/bnhs.png">
  <meta name="theme-color" content="#ffffff">
  <link href="assets/css/bootstrap.css" rel="stylesheet">
  <script src="assets/js/jquery.js"></script>
 <!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap 5 JavaScript Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="container mt-5" id="printableArea">
    <div id="list" class="col-10 offset-1 col-md-8 offset-md-2">
      <div class="row">


        <div class="text-center mb-4">
          <h5>REPORT ON THE PHYSICAL COUNT OF PROPERTY, PLANT AND EQUIPMENT</h5>
          <h6>IT EQUIPMENT</h6>
          <p>As of <?php echo strtoupper(date('F Y')); ?></p>
        </div>

        <p><strong>Fund Cluster:</strong><strong>__________________________</strong></p>
        <p>
          <strong>For which:</strong> CodeAstro Lounge &nbsp;&nbsp;
          <strong>Administrative Officer:</strong> John Doe &nbsp;&nbsp;
          <strong>As of:</strong> <?php echo date('F d, Y'); ?>
        </p>

        <table class="table table-bordered text-center">
          <thead class="thead-light">
            <tr>
              <th>ARTICLE</th>
              <th>DESCRIPTION</th>
              <th>PROPERTY NO.</th>
              <th>UNIT OF MEASURE</th>
              <th>UNIT VALUE</th>
              <th>QTY PER CARD</th>
              <th>QTY PER COUNT</th>
              <th>SHORTAGE/ OVERAGE</th>
              <th>REMARKS</th>
            </tr>
          </thead>
          <tbody>
            <?php
            $ret = "SELECT * FROM bnhs_staff";
            $stmt = $mysqli->prepare($ret);
            $stmt->execute();
            $res = $stmt->get_result();

            while ($staff = $res->fetch_object()) {
              ?>
              <tr>
                <td>IT EQUIPMENT</td>
                <td>sad</td>
                <td>sadad ?></td>
                <td>pcs</td>
                <td>sadasd ?></td>
                <td>sadas; ?></td>
                <td>asdasd?></td>
                <td>0</td>
                <td>Good Condition</td>
              </tr>
            <?php } ?>
          </tbody>
        </table>

        <br><br>
        <div class="row text-center mt-5">
          <div class="col-md-4">
            <p>Certified Correct:</p><br><br>
            <strong>__________________________</strong><br>
            <em>Inventory Committee Chair</em>
          </div>
          <div class="col-md-4">
            <p>Approved by:</p><br><br>
            <strong>__________________________</strong><br>
            <em>School Head / Admin Officer</em>
          </div>
          <div class="col-md-4">
            <p>Verified by:</p><br><br>
            <strong>__________________________</strong><br>
            <em>COA Representative</em>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Print Button -->
  <div class="col-xs-2 col-sm-2 col-md-1 col-xs-offset-1 col-sm-offset-1 col-md-offset-8 " style="margin-top: 40px;">
    <button id="print" onclick="printContent('list');" class="btn btn-primary btn-lg text-justify btn-block">
      Print <span class="fas fa-print"></span>
    </button>
  </div>

</body>
<script>
  function printContent(el) {
    var restorepage = $('body').html();
    var printcontent = $('#' + el).clone();
    $('body').empty().html(printcontent);
    window.print();
    $('body').html(restorepage);
  }
</script>

</html>


<?php
session_start();
include('config/config.php');
include('config/checklogin.php');
check_login();
//Delete Staff
if (isset($_GET['delete'])) {
  $id = $_GET['delete'];
  $adn = "DELETE FROM  bnhs_staff  WHERE  staff_id = ?";
  $stmt = $mysqli->prepare($adn);
  $stmt->bind_param('s', $id);
  $stmt->execute();
  $stmt->close();
  if ($stmt) {
    $success = "Deleted" && header("refresh:1; url=user_management.php");
  } else {
    $err = "Try Again Later";
  }
}
require_once('partials/_head.php');
?>

<body>
  <!-- Sidenav -->
  <?php
  require_once('partials/_sidebar.php');
  ?>
  <!-- Main content -->
  <div class="main-content">
    <!-- Top navbar -->
    <?php
    require_once('partials/_topnav.php');
    ?>
    <style>
      /* Custom styles for inventory management tabs */
      .custom-tabs {
        margin-bottom: 15px;
      }

      .custom-tab-link {
        font-weight: bold;
        color: #495057;
        padding: 15px 30px;
        transition: color 0.3s, background-color 0.3s;
      }

      .custom-tab-link:hover {
        color: #0056b3;
        background-color: #f8f9fa;
      }

    </style>
    <!-- Header -->
    <div style="background-image: url(assets/img/theme/bnhsfront.jpg); background-size: cover;"
      class="header  pb-8 pt-5 pt-md-8">
      <span class="mask bg-gradient-dark opacity-8"></span>
      <div class="container-fluid">
        <div class="header-body">
        </div>
      </div>
    </div>
    <!-- Page content -->
    <div class="container-fluid mt--8">
      <!-- Table -->
      <div class="row">
        <div class="col">

          <div class="card shadow">
            <!-- Tabs -->
            <ul class="nav nav-tabs custom-tabs" id="myTab" role="tablist">
              <li class="nav-item">
                <a class="nav-link active custom-tab-link" id="teachers-tab" data-toggle="tab" href="#teachers"
                  role="tab" aria-controls="teachers" aria-selected="true">Teachers</a>
              </li>
              <li class="nav-item">
                <a class="nav-link custom-tab-link" id="staff-tab" data-toggle="tab" href="#staff" role="tab"
                  aria-controls="staff" aria-selected="false">Staff</a>
              </li>
              <li class="nav-item">
                <a class="nav-link custom-tab-link" id="admins-tab" data-toggle="tab" href="#admins" role="tab"
                  aria-controls="admins" aria-selected="false">Admins</a>
              </li>
            </ul>

            <div class="tab-content" id="myTabContent">
              <!-- Teachers Tab -->
              <div class="tab-pane fade show active" id="teachers" role="tabpanel" aria-labelledby="teachers-tab">
                <div class="card-header border-0">
                  <div class="row align-items-center">
                    <a href="add_teacher.php" class="btn btn-outline-success mx-3">
                      <i class="fas fa-user-plus"></i>
                      Add New Teacher
                    </a>
                    <div class="col text-right">
                      <a href="orders_reports.php" class="btn btn-sm btn-primary">See all</a>
                    </div>
                  </div>

                </div>

                <div class="table-responsive">
                  <table class="table align-items-center table-flush">
                    <thead class="thead-light">
                      <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Full Name</th>
                        <th scope="col">Subject</th>
                        <th scope="col">Email</th>
                        <th scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <?php
                      $ret = "SELECT * FROM bnhs_staff ORDER BY created_at DESC";
                      $stmt = $mysqli->prepare($ret);
                      $stmt->execute();
                      $res = $stmt->get_result();
                      while ($teacher = $res->fetch_object()) {
                        ?>
                        <tr>
                          <td><?php echo $teacher->teacher_id; ?></td>
                          <td><?php echo $teacher->teacher_name; ?></td>
                          <td><?php echo $teacher->teacher_subject; ?></td>
                          <td><?php echo $teacher->teacher_email; ?></td>
                          <td>
                            <a href="update_teacher.php?update=<?php echo $teacher->teacher_id; ?>">
                              <button class="btn btn-sm btn-primary">
                                <i class="fas fa-user-edit"></i> Update
                              </button>
                            </a>
                            <a href="delete_teacher.php?delete=<?php echo $teacher->teacher_id; ?>">
                              <button class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </a>
                          </td>
                        </tr>
                      <?php } ?>
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- Staff Tab -->
              <div class="tab-pane fade" id="staff" role="tabpanel" aria-labelledby="staff-tab">
              <div class="card-header border-0">
                  <div class="row align-items-center">
                    <a href="add_teacher.php" class="btn btn-outline-success mx-3">
                      <i class="fas fa-user-plus"></i>
                      Add New Staff
                    </a>
                    <div class="col text-right">
                      <a href="orders_reports.php" class="btn btn-sm btn-primary">See all</a>
                    </div>
                  </div>

                </div>

                <div class="table-responsive">
                  <table class="table align-items-center table-flush">
                    <thead class="thead-light">
                      <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Full Name</th>
                        <th scope="col">Contact Number</th>
                        <th scope="col">Email</th>
                        <th scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <?php
                      $ret = "SELECT * FROM bnhs_staff ORDER BY created_at DESC";
                      $stmt = $mysqli->prepare($ret);
                      $stmt->execute();
                      $res = $stmt->get_result();
                      while ($staff = $res->fetch_object()) {
                        ?>
                        <tr>
                          <td><?php echo $staff->staff_id; ?></td>
                          <td><?php echo $staff->staff_name; ?></td>
                          <td><?php echo $staff->staff_phoneno; ?></td>
                          <td><?php echo $staff->staff_email; ?></td>
                          <td>
                            <a href="update_staff.php?update=<?php echo $staff->staff_id; ?>">
                              <button class="btn btn-sm btn-primary">
                                <i class="fas fa-user-edit"></i> Update
                              </button>
                            </a>
                            <a href="delete_staff.php?delete=<?php echo $staff->staff_id; ?>">
                              <button class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </a>
                          </td>
                        </tr>
                      <?php } ?>
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- Admins Tab -->
              <div class="tab-pane fade" id="admins" role="tabpanel" aria-labelledby="admins-tab">
              <div class="card-header border-0">
                  <div class="row align-items-center">
                    <a href="add_teacher.php" class="btn btn-outline-success mx-3">
                      <i class="fas fa-user-plus"></i>
                      Add New Admin
                    </a>
                    <div class="col text-right">
                      <a href="orders_reports.php" class="btn btn-sm btn-primary">See all</a>
                    </div>
                  </div>
                </div>

                <div class="table-responsive">
                  <table class="table align-items-center table-flush">
                    <thead class="thead-light">
                      <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Full Name</th>
                        <th scope="col">Role</th>
                        <th scope="col">Email</th>
                        <th scope="col">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <?php
                      $ret = "SELECT * FROM bnhs_admins ORDER BY created_at DESC";
                      $stmt = $mysqli->prepare($ret);
                      $stmt->execute();
                      $res = $stmt->get_result();
                      while ($admin = $res->fetch_object()) {
                        ?>
                        <tr>
                          <td><?php echo $admin->admin_id; ?></td>
                          <td><?php echo $admin->admin_name; ?></td>
                          <td><?php echo $admin->admin_role; ?></td>
                          <td><?php echo $admin->admin_email; ?></td>
                          <td>
                            <a href="update_admin.php?update=<?php echo $admin->admin_id; ?>">
                              <button class="btn btn-sm btn-primary">
                                <i class="fas fa-user-edit"></i> Update
                              </button>
                            </a>
                            <a href="delete_admin.php?delete=<?php echo $admin->admin_id; ?>">
                              <button class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i> Delete
                              </button>
                            </a>
                          </td>
                        </tr>
                      <?php } ?>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Footer -->
      <?php
      require_once('partials/_mainfooter.php');
      ?>
    </div>
  </div>
  <!-- Argon Scripts -->
  <?php
  require_once('partials/_scripts.php');
  ?>
</body>

</html>


<?php
session_start();
include('config/config.php');
include('config/checklogin.php');
check_login();

function sanitize($data) {
    return htmlspecialchars(trim($data));
}

// Helper function to get database value or default
function get_field_value($item, $field, $default = '') {
    return isset($item[$field]) && $item[$field] !== null ? $item[$field] : $default;
}

$tables = [
  'inspection_acceptance_reports',
  'inventory_custodian_slips',
  'requisition_and_issue_slips',
  'property_acknowledgment_receipts'
];

// Get parameters
$source_table = isset($_GET['table']) ? $_GET['table'] : '';
$record_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

// Validate
if (!in_array($source_table, $tables) || $record_id <= 0) {
    die("Invalid table or ID.");
}

// Fetch existing record
$id_column = 'id';
switch($source_table) {
    case 'inspection_acceptance_reports': $id_column = 'iar_id'; break;
    case 'inventory_custodian_slips': $id_column = 'ics_id'; break;
    case 'requisition_and_issue_slips': $id_column = 'ris_id'; break;
    case 'property_acknowledgment_receipts': $id_column = 'par_id'; break;
}

// Modified query with JOIN to entities table where applicable
if ($source_table == 'inspection_acceptance_reports') {
    $query = "SELECT t.*, e.entity_name, e.fund_cluster,
              i.item_id, i.quantity, i.unit_price, i.total_price,
              itm.item_description, itm.unit, itm.unit_cost, itm.stock_no,
              s.supplier_name, s.contact_info
              FROM `$source_table` t 
              JOIN entities e ON t.entity_id = e.entity_id 
              LEFT JOIN iar_items i ON t.iar_id = i.iar_id
              LEFT JOIN items itm ON i.item_id = itm.item_id
              LEFT JOIN suppliers s ON t.supplier_id = s.supplier_id
              WHERE t.$id_column = ?";
} else if ($source_table == 'inventory_custodian_slips') {
    $query = "SELECT t.*, e.entity_name, e.fund_cluster,
              i.item_id, i.quantity, i.inventory_item_no,
              itm.item_description, itm.unit, itm.unit_cost, itm.estimated_useful_life
              FROM `$source_table` t 
              JOIN entities e ON t.entity_id = e.entity_id 
              LEFT JOIN ics_items i ON t.ics_id = i.ics_id
              LEFT JOIN items itm ON i.item_id = itm.item_id
              WHERE t.$id_column = ?";
} else if ($source_table == 'requisition_and_issue_slips') {
    $query = "SELECT t.*, e.entity_name, e.fund_cluster,
              i.item_id, i.requested_qty, i.issued_qty, i.stock_available, i.remarks,
              itm.item_description, itm.unit, itm.unit_cost, itm.stock_no
              FROM `$source_table` t 
              JOIN entities e ON t.entity_id = e.entity_id 
              LEFT JOIN ris_items i ON t.ris_id = i.ris_id
              LEFT JOIN items itm ON i.item_id = itm.item_id
              WHERE t.$id_column = ?";
} else if ($source_table == 'property_acknowledgment_receipts') {
    $query = "SELECT t.*, e.entity_name, e.fund_cluster,
              i.item_id, i.quantity, i.property_number,
              itm.item_description, itm.unit, itm.unit_cost
              FROM `$source_table` t 
              JOIN entities e ON t.entity_id = e.entity_id 
              LEFT JOIN par_items i ON t.par_id = i.par_id
              LEFT JOIN items itm ON i.item_id = itm.item_id
              WHERE t.$id_column = ?";
} else {
    $query = "SELECT * FROM `$source_table` WHERE $id_column = ?";
}

$stmt = $mysqli->prepare($query);
if ($stmt === false) {
    die("Error preparing statement: " . $mysqli->error);
}
$stmt->bind_param("i", $record_id);
$stmt->execute();
$result = $stmt->get_result();
$item = $result->fetch_assoc();

if (!$item) {
    die("Record not found.");
}

if ($_SERVER['REQUEST_METHOD'] === "POST") {
    // Gather input based on table type
    $fields = [];
    $values = [];
    $updates = [];

    switch($source_table) {
        case 'inspection_acceptance_reports':
            $fields = [
                'entity_id', 'iar_no', 'quantity', 'unit', 'item_description',
                'property_number', 'date_acquired', 'unit_cost', 'total_cost', 'receiver_name',
                'receiver_position', 'receiver_date', 'property_custodian', 'custodian_position',
                'custodian_date', 'supplier_id', 'po_no_date', 'req_office', 'responsibility_center',
                'iar_date', 'invoice_no_date', 'stock_no', 'remarks', 'unit_price', 'total_price',
                'teacher_id', 'position', 'date_inspected', 'inspectors', 'barangay_councilor',
                'pta_observer', 'date_received', 'entity_name', 'fund_cluster', 'supplier_name'
            ];
            break;
        case 'inventory_custodian_slips':
            $fields = [
                'entity_id', 'ics_no', 'end_user_name', 'end_user_position', 
                'end_user_date', 'custodian_name', 'custodian_position', 'custodian_date',
                'quantity', 'unit', 'unit_cost', 'total_amount', 'item_description',
                'inventory_item_no', 'estimated_useful_life', 'entity_name', 'fund_cluster'
            ];
            break;
        case 'requisition_and_issue_slips':
            $fields = [
                'entity_id', 'ris_no', 'quantity', 'unit', 'item_description',
                'stock_no', 'date_acquired', 'unit_cost', 'total_cost', 'requested_by_name',
                'requested_by_position', 'requested_by_date', 'issued_by_name', 'issued_by_position',
                'issued_by_date', 'division', 'office', 'responsibility_code', 'requested_qty', 
                'stock_available', 'issued_qty', 'remarks', 'purpose', 'requested_by_designation',
                'approved_by_name', 'approved_by_designation', 'approved_by_date',
                'issued_by_designation', 'received_by_name', 'received_by_designation', 
                'received_by_date', 'entity_name', 'fund_cluster'
            ];
            break;
        case 'property_acknowledgment_receipts':
            $fields = ['entity_id', 'par_no', 'quantity', 'unit', 'item_description',
                      'property_number', 'date_acquired', 'unit_cost', 'total_amount',
                      'end_user_name', 'receiver_position', 'receiver_date',
                      'custodian_name', 'custodian_position', 'custodian_date',
                      'entity_name', 'fund_cluster'];
            break;
    }

    foreach ($fields as $field) {
        if (isset($_POST[$field])) {
            $updates[] = "`$field` = ?";
            $values[] = sanitize($_POST[$field]);
        }
    }

    if (!empty($updates)) {
        $setClause = implode(', ', $updates);
        $sql = "UPDATE `$source_table` SET $setClause WHERE $id_column = ?";
        
        // Debug information
        error_log("SQL Query: " . $sql);
        error_log("Table: " . $source_table);
        error_log("ID Column: " . $id_column);
        error_log("Record ID: " . $record_id);
        error_log("Updates: " . print_r($updates, true));
        error_log("Values: " . print_r($values, true));
        
        $stmt = $mysqli->prepare($sql);
        
        if ($stmt === false) {
            $err = "Error preparing statement: " . $mysqli->error;
            error_log("MySQL Error: " . $mysqli->error);
        } else {
            // Create an array of references for bind_param
            $types = str_repeat('s', count($values)) . 'i';
            $values[] = $record_id;
            
            // Bind parameters directly
            $stmt->bind_param($types, ...$values);

            if ($stmt->execute()) {
                // Handle entity_name and fund_cluster updates if they've changed
                if (isset($_POST['entity_name']) && isset($_POST['fund_cluster']) && isset($_POST['entity_id'])) {
                    $entity_id = $_POST['entity_id'];
                    $entity_name = sanitize($_POST['entity_name']);
                    $fund_cluster = sanitize($_POST['fund_cluster']);
                    
                    // Update the entities table
                    $entity_sql = "UPDATE entities SET entity_name = ?, fund_cluster = ? WHERE entity_id = ?";
                    $entity_stmt = $mysqli->prepare($entity_sql);
                    if ($entity_stmt) {
                        $entity_stmt->bind_param("ssi", $entity_name, $fund_cluster, $entity_id);
                        $entity_stmt->execute();
                        $entity_stmt->close();
                    }
                }
                
                // Handle supplier_name updates for IAR
                if ($source_table == 'inspection_acceptance_reports' && isset($_POST['supplier_name']) && isset($_POST['supplier_id'])) {
                    $supplier_id = $_POST['supplier_id'];
                    $supplier_name = sanitize($_POST['supplier_name']);
                    
                    // Update the suppliers table
                    $supplier_sql = "UPDATE suppliers SET supplier_name = ? WHERE supplier_id = ?";
                    $supplier_stmt = $mysqli->prepare($supplier_sql);
                    if ($supplier_stmt) {
                        $supplier_stmt->bind_param("si", $supplier_name, $supplier_id);
                        $supplier_stmt->execute();
                        $supplier_stmt->close();
                    }
                }
                
                // Update the item-related tables based on the source table
                if ($source_table == 'inspection_acceptance_reports' && isset($_POST['quantity']) && isset($_POST['unit_price'])) {
                    $quantity = intval($_POST['quantity']);
                    $unit_price = floatval($_POST['unit_price']);
                    $total_price = $quantity * $unit_price;
                    
                    // Find the first iar_item_id for this IAR
                    $find_sql = "SELECT iar_item_id FROM iar_items WHERE iar_id = ? LIMIT 1";
                    $find_stmt = $mysqli->prepare($find_sql);
                    if ($find_stmt) {
                        $find_stmt->bind_param('i', $record_id);
                        $find_stmt->execute();
                        $find_result = $find_stmt->get_result();
                        if ($row = $find_result->fetch_assoc()) {
                            $iar_item_id = $row['iar_item_id'];
                            
                            // Update the iar_items table
                            $update_sql = "UPDATE iar_items SET quantity = ?, unit_price = ?, total_price = ? WHERE iar_item_id = ?";
                            $update_stmt = $mysqli->prepare($update_sql);
                            if ($update_stmt) {
                                $update_stmt->bind_param('iddi', $quantity, $unit_price, $total_price, $iar_item_id);
                                $update_stmt->execute();
                                $update_stmt->close();
                            }
                        }
                        $find_stmt->close();
                    }
                } 
                else if ($source_table == 'inventory_custodian_slips' && isset($_POST['quantity']) && isset($_POST['unit_cost'])) {
                    $quantity = intval($_POST['quantity']);
                    $unit_cost = floatval($_POST['unit_cost']);
                    
                    // Find the first ics_item_id for this ICS
                    $find_sql = "SELECT ics_item_id, item_id FROM ics_items WHERE ics_id = ? LIMIT 1";
                    $find_stmt = $mysqli->prepare($find_sql);
                    if ($find_stmt) {
                        $find_stmt->bind_param('i', $record_id);
                        $find_stmt->execute();
                        $find_result = $find_stmt->get_result();
                        if ($row = $find_result->fetch_assoc()) {
                            $ics_item_id = $row['ics_item_id'];
                            $item_id = $row['item_id'];
                            
                            // Update the ics_items table
                            $update_sql = "UPDATE ics_items SET quantity = ? WHERE ics_item_id = ?";
                            $update_stmt = $mysqli->prepare($update_sql);
                            if ($update_stmt) {
                                $update_stmt->bind_param('ii', $quantity, $ics_item_id);
                                $update_stmt->execute();
                                $update_stmt->close();
                            }
                            
                            // Update the items table with new unit_cost
                            $update_items_sql = "UPDATE items SET unit_cost = ? WHERE item_id = ?";
                            $update_items_stmt = $mysqli->prepare($update_items_sql);
                            if ($update_items_stmt) {
                                $update_items_stmt->bind_param('di', $unit_cost, $item_id);
                                $update_items_stmt->execute();
                                $update_items_stmt->close();
                            }
                        }
                        $find_stmt->close();
                    }
                } 
                else if ($source_table == 'requisition_and_issue_slips' && isset($_POST['requested_qty']) && isset($_POST['unit_cost'])) {
                    $requested_qty = intval($_POST['requested_qty']);
                    $unit_cost = floatval($_POST['unit_cost']);
                    
                    // Find the first ris_item_id for this RIS
                    $find_sql = "SELECT ris_item_id, item_id FROM ris_items WHERE ris_id = ? LIMIT 1";
                    $find_stmt = $mysqli->prepare($find_sql);
                    if ($find_stmt) {
                        $find_stmt->bind_param('i', $record_id);
                        $find_stmt->execute();
                        $find_result = $find_stmt->get_result();
                        if ($row = $find_result->fetch_assoc()) {
                            $ris_item_id = $row['ris_item_id'];
                            $item_id = $row['item_id'];
                            
                            // Update the ris_items table
                            $update_sql = "UPDATE ris_items SET requested_qty = ? WHERE ris_item_id = ?";
                            $update_stmt = $mysqli->prepare($update_sql);
                            if ($update_stmt) {
                                $update_stmt->bind_param('ii', $requested_qty, $ris_item_id);
                                $update_stmt->execute();
                                $update_stmt->close();
                            }
                            
                            // Update the items table with new unit_cost
                            $update_items_sql = "UPDATE items SET unit_cost = ? WHERE item_id = ?";
                            $update_items_stmt = $mysqli->prepare($update_items_sql);
                            if ($update_items_stmt) {
                                $update_items_stmt->bind_param('di', $unit_cost, $item_id);
                                $update_items_stmt->execute();
                                $update_items_stmt->close();
                            }
                        }
                        $find_stmt->close();
                    }
                } 
                else if ($source_table == 'property_acknowledgment_receipts' && isset($_POST['quantity']) && isset($_POST['unit_cost'])) {
                    $quantity = intval($_POST['quantity']);
                    $unit_cost = floatval($_POST['unit_cost']);
                    
                    // Find the first par_item_id for this PAR
                    $find_sql = "SELECT par_item_id, item_id FROM par_items WHERE par_id = ? LIMIT 1";
                    $find_stmt = $mysqli->prepare($find_sql);
                    if ($find_stmt) {
                        $find_stmt->bind_param('i', $record_id);
                        $find_stmt->execute();
                        $find_result = $find_stmt->get_result();
                        if ($row = $find_result->fetch_assoc()) {
                            $par_item_id = $row['par_item_id'];
                            $item_id = $row['item_id'];
                            
                            // Update the par_items table
                            $update_sql = "UPDATE par_items SET quantity = ? WHERE par_item_id = ?";
                            $update_stmt = $mysqli->prepare($update_sql);
                            if ($update_stmt) {
                                $update_stmt->bind_param('ii', $quantity, $par_item_id);
                                $update_stmt->execute();
                                $update_stmt->close();
                            }
                            
                            // Update the items table with new unit_cost
                            $update_items_sql = "UPDATE items SET unit_cost = ? WHERE item_id = ?";
                            $update_items_stmt = $mysqli->prepare($update_items_sql);
                            if ($update_items_stmt) {
                                $update_items_stmt->bind_param('di', $unit_cost, $item_id);
                                $update_items_stmt->execute();
                                $update_items_stmt->close();
                            }
                        }
                        $find_stmt->close();
                    }
                }
                
                $success = "Record updated successfully.";
                // Redirect to the same page to prevent form resubmission
                header("Location: track_inventory.php?success=Record updated successfully");
                exit();
            } else {
                $err = "Update failed: " . $stmt->error;
                error_log("Execute Error: " . $stmt->error);
            }
            $stmt->close();
        }
    }
}

require_once('partials/_head.php');
?>

<body>
<?php require_once('partials/_sidebar.php'); ?>
<div class="main-content">
<?php require_once('partials/_topnav.php'); ?>

<div style="background-image: url(assets/img/theme/bnhsfront.jpg); background-size: cover;" class="header pb-8 pt-5 pt-md-8">
  <span class="mask bg-gradient-dark opacity-8"></span>
</div>

<div class="container-fluid mt--8">
  <div class="row">
    <div class="col">
      <div class="card shadow">
        <div class="card-body">
          <form method="POST" class="border border-light p-4 rounded">
            <div class="container mt-4">
              <?php /* Temporary debugging */ ?>
              <div style="display: none;">
                <?php var_dump($item); ?>
              </div>
              
              <?php if ($source_table === 'property_acknowledgment_receipts'): ?>
                <h2 class="text-center mb-4 text-uppercase">Purchase Acceptance Report</h2>
                <!-- Entity Info -->
                <div class="row mt-3 mb-3">
                    <div class="col-md-4">
                        <label>Entity Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="entity_name" value="<?php echo get_field_value($item, 'entity_name'); ?>" required>
                        <input type="hidden" name="entity_id" value="<?php echo get_field_value($item, 'entity_id'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Fund Cluster</label>
                        <input style="color: #000000;" type="text" class="form-control" name="fund_cluster" value="<?php echo get_field_value($item, 'fund_cluster'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label>PAR No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="par_no" value="<?php echo get_field_value($item, 'par_no'); ?>" required>
                    </div>
                </div>
                <!-- Item Info -->
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label>Quantity</label>
                        <input style="color: #000000;" type="number" class="form-control" name="quantity" value="<?php echo get_field_value($item, 'quantity'); ?>">
                    </div>
                    <div class="col-md-2">
                        <label>Unit</label>
                        <input style="color: #000000;" type="text" class="form-control" name="unit" value="<?php echo get_field_value($item, 'unit'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Description</label>
                        <input style="color: #000000;" type="text" class="form-control" name="item_description" value="<?php echo get_field_value($item, 'item_description'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Property Number</label>
                        <input style="color: #000000;" type="text" class="form-control" name="property_number" value="<?php echo get_field_value($item, 'property_number'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Date Acquired</label>
                        <input style="color: #000000;" type="date" class="form-control" name="date_acquired" value="<?php echo get_field_value($item, 'date_acquired'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Unit Cost</label>
                        <input style="color: #000000;" type="text" class="form-control" name="unit_cost" value="<?php echo get_field_value($item, 'unit_cost'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Total Amount</label>
                        <input style="color: #000000; background-color: white;" type="text" class="form-control" name="total_amount" value="<?php echo get_field_value($item, 'total_amount'); ?>" readonly>
                    </div>
                </div>
                <!-- Receiver Section -->
                <div class="sub-section receiver-section">Receiver</div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>End User Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="end_user_name" value="<?php echo get_field_value($item, 'end_user_name'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Position/Office</label>
                        <input style="color: #000000;" type="text" class="form-control" name="receiver_position" value="<?php echo get_field_value($item, 'receiver_position'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Date</label>
                        <input style="color: #000000;" type="date" class="form-control" name="receiver_date" value="<?php echo get_field_value($item, 'receiver_date'); ?>">
                    </div>
                </div>
                <!-- Issue Section -->
                <div class="sub-section issue-section">Issue</div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label>Property Custodian Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="custodian_name" value="<?php echo get_field_value($item, 'custodian_name'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Position/Office</label>
                        <input style="color: #000000;" type="text" class="form-control" name="custodian_position" value="<?php echo get_field_value($item, 'custodian_position'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label>Date</label>
                        <input style="color: #000000;" type="date" class="form-control" name="custodian_date" value="<?php echo get_field_value($item, 'custodian_date'); ?>">
                    </div>
                </div>

              <?php elseif ($source_table === 'requisition_and_issue_slips'): ?>
                <h2 class="text-center mb-4 text-uppercase">Requisition and Issue Slip</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Entity Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="entity_name" value="<?php echo get_field_value($item, 'entity_name'); ?>" required>
                        <input type="hidden" name="entity_id" value="<?php echo get_field_value($item, 'entity_id'); ?>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fund Cluster</label>
                        <input style="color: #000000;" type="text" class="form-control" name="fund_cluster" value="<?php echo get_field_value($item, 'fund_cluster'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Division</label>
                        <input style="color: #000000;" type="text" class="form-control" name="division" value="<?php echo get_field_value($item, 'division'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Office</label>
                        <input style="color: #000000;" type="text" class="form-control" name="office" value="<?php echo get_field_value($item, 'office'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Responsibility Center Code</label>
                        <input style="color: #000000;" type="text" class="form-control" name="responsibility_code" value="<?php echo get_field_value($item, 'responsibility_code'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">RIS No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="ris_no" value="<?php echo get_field_value($item, 'ris_no'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Stock No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="stock_no" value="<?php echo get_field_value($item, 'stock_no'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unit</label>
                        <input style="color: #000000;" type="text" class="form-control" name="unit" value="<?php echo get_field_value($item, 'unit'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Item Description</label>
                        <input style="color: #000000;" type="text" style="color: #000000;" class="form-control" name="item_description" value="<?php echo get_field_value($item, 'item_description'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Requested Quantity</label>
                        <input style="color: #000000;" type="number" style="color: #000000;" class="form-control" name="requested_qty" value="<?php echo get_field_value($item, 'requested_qty'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Stock Available (Yes/No)</label>
                        <select style="color: #000000;" class="form-control" name="stock_available" required>
                            <option value="yes" <?php echo get_field_value($item, 'stock_available') === 'yes' ? 'selected' : ''; ?>>Yes</option>
                            <option value="no" <?php echo get_field_value($item, 'stock_available') === 'no' ? 'selected' : ''; ?>>No</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Issued Quantity</label>
                        <input style="color: #000000;" type="number" style="color: #000000;" class="form-control" name="issued_qty" value="<?php echo get_field_value($item, 'issued_qty'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Remarks</label>
                        <input style="color: #000000;" type="text" style="color: #000000;" class="form-control" name="remarks" value="<?php echo get_field_value($item, 'remarks'); ?>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Purpose</label>
                        <input style="color: #000000;" type="text" style="color: #000000;" class="form-control" name="purpose" value="<?php echo get_field_value($item, 'purpose'); ?>" required>
                    </div>
                </div>
                <h5 class="mt-4">Requested By</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Name</label>
                        <input type="text" style="color: #000000;" class="form-control" name="requested_by_name" value="<?php echo get_field_value($item, 'requested_by_name'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Designation</label>
                        <input type="text" style="color: #000000;" class="form-control" name="requested_by_designation" value="<?php echo get_field_value($item, 'requested_by_designation'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input type="date" style="color: #000000;" class="form-control" name="requested_by_date" value="<?php echo get_field_value($item, 'requested_by_date'); ?>" required>
                    </div>
                </div>
                <h5>Approved By</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Name</label>
                        <input type="text" style="color: #000000;" class="form-control" name="approved_by_name" value="<?php echo get_field_value($item, 'approved_by_name'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Designation</label>
                        <input type="text" style="color: #000000;" class="form-control" name="approved_by_designation" value="<?php echo get_field_value($item, 'approved_by_designation'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input type="date" style="color: #000000;" class="form-control" name="approved_by_date" value="<?php echo $item['approved_by_date'] ?? ''; ?>" required>
                    </div>
                </div>
                <h5>Issued By</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Name</label>
                        <input type="text" style="color: #000000;" class="form-control" name="issued_by_name" value="<?php echo get_field_value($item, 'issued_by_name'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Designation</label>
                        <input type="text" style="color: #000000;" class="form-control" name="issued_by_designation" value="<?php echo get_field_value($item, 'issued_by_designation'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input type="date" style="color: #000000;" class="form-control" name="issued_by_date" value="<?php echo get_field_value($item, 'issued_by_date'); ?>" required>
                    </div>
                </div>
                <h5>Received By</h5>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Name</label>
                        <input type="text" style="color: #000000;" class="form-control" name="received_by_name" value="<?php echo get_field_value($item, 'received_by_name'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Designation</label>
                        <input type="text" style="color: #000000;" class="form-control" name="received_by_designation" value="<?php echo get_field_value($item, 'received_by_designation'); ?>" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Date</label>
                        <input type="date" style="color: #000000;" class="form-control" name="received_by_date" value="<?php echo get_field_value($item, 'received_by_date'); ?>" required>
                    </div>
                </div>

              <?php elseif ($source_table === 'inventory_custodian_slips'): ?>
                <h2 class="text-center mb-4 text-uppercase">Inventory Custodian Slip</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Entity Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="entity_name" value="<?php echo get_field_value($item, 'entity_name'); ?>" required>
                        <input type="hidden" name="entity_id" value="<?php echo get_field_value($item, 'entity_id'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fund Cluster</label>
                        <input style="color: #000000;" type="text" class="form-control" name="fund_cluster" value="<?php echo get_field_value($item, 'fund_cluster'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ICS No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="ics_no" value="<?php echo get_field_value($item, 'ics_no'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Quantity</label>
                        <input style="color: #000000;" type="number" class="form-control" name="quantity" value="<?php echo get_field_value($item, 'quantity'); ?>" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Unit</label>
                        <input style="color: #000000;" type="text" class="form-control" name="unit" value="<?php echo get_field_value($item, 'unit'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Unit Cost</label>
                        <input style="color: #000000;" type="text" class="form-control" name="unit_cost" value="<?php echo get_field_value($item, 'unit_cost'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Total Amount</label>
                        <input style="color: #000000; background-color: white;" type="text" class="form-control" name="total_amount" value="<?php echo get_field_value($item, 'total_amount'); ?>" readonly>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Item Description</label>
                        <input style="color: #000000;" type="text" class="form-control" name="item_description" value="<?php echo get_field_value($item, 'item_description'); ?>" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Inventory Item No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="inventory_item_no" value="<?php echo get_field_value($item, 'inventory_item_no'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Estimated Useful Life</label>
                        <input style="color: #000000;" type="text" class="form-control" name="estimated_useful_life" value="<?php echo get_field_value($item, 'estimated_useful_life'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">End User Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="end_user_name" value="<?php echo get_field_value($item, 'end_user_name'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Position / Office</label>
                        <input style="color: #000000;" type="text" class="form-control" name="end_user_position" value="<?php echo get_field_value($item, 'end_user_position'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Date Received (by End User)</label>
                        <input style="color: #000000;" type="date" class="form-control" name="end_user_date" value="<?php echo get_field_value($item, 'end_user_date'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Property Custodian Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="custodian_name" value="<?php echo get_field_value($item, 'custodian_name'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Position / Office (Custodian)</label>
                        <input style="color: #000000;" type="text" class="form-control" name="custodian_position" value="<?php echo get_field_value($item, 'custodian_position'); ?>" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Date Received (by Custodian)</label>
                        <input style="color: #000000;" type="date" class="form-control" name="custodian_date" value="<?php echo get_field_value($item, 'custodian_date'); ?>" required>
                    </div>
                </div>

              <?php elseif ($source_table === 'inspection_acceptance_reports'): ?>
                <h2 class="text-center mb-4 text-uppercase">Inspection and Acceptance Report</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Entity Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="entity_name" value="<?php echo get_field_value($item, 'entity_name'); ?>" required>
                        <input type="hidden" name="entity_id" value="<?php echo get_field_value($item, 'entity_id'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fund Cluster</label>
                        <input style="color: #000000;" type="text" class="form-control" name="fund_cluster" value="<?php echo get_field_value($item, 'fund_cluster'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Supplier</label>
                        <input style="color: #000000;" type="text" class="form-control" name="supplier_name" value="<?php echo get_field_value($item, 'supplier_name'); ?>" required>
                        <input type="hidden" name="supplier_id" value="<?php echo get_field_value($item, 'supplier_id'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">PO No. / Date</label>
                        <input style="color: #000000;" type="text" class="form-control" name="po_no_date" value="<?php echo get_field_value($item, 'po_no_date'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Requisitioning Office/Dept.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="req_office" value="<?php echo get_field_value($item, 'req_office'); ?>" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Responsibility Center</label>
                        <input style="color: #000000;" type="text" class="form-control" name="responsibility_center" value="<?php echo get_field_value($item, 'responsibility_center'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">IAR No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="iar_no" value="<?php echo get_field_value($item, 'iar_no'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">IAR Date</label>
                        <input style="color: #000000;" type="date" class="form-control" name="iar_date" value="<?php echo get_field_value($item, 'iar_date'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Invoice No. / Date</label>
                        <input style="color: #000000;" type="text" class="form-control" name="invoice_no_date" value="<?php echo get_field_value($item, 'invoice_no_date'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Stock / Property No.</label>
                        <input style="color: #000000;" type="text" class="form-control" name="stock_no" value="<?php echo get_field_value($item, 'stock_no'); ?>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Remarks</label>
                        <input style="color: #000000;" type="text" class="form-control" name="remarks" value="<?php echo get_field_value($item, 'remarks'); ?>">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Item Description</label>
                        <input style="color: #000000;" type="text" class="form-control" name="item_description" value="<?php echo get_field_value($item, 'item_description'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Unit</label>
                        <input style="color: #000000;" type="text" class="form-control" name="unit" value="<?php echo get_field_value($item, 'unit'); ?>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Qty</label>
                        <input style="color: #000000;" type="number" class="form-control" name="quantity" value="<?php echo get_field_value($item, 'quantity'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Unit Price</label>
                        <input style="color: #000000;" type="number" step="0.01" class="form-control" name="unit_price" value="<?php echo get_field_value($item, 'unit_price'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Total Price</label>
                        <input style="color: #000000; background-color: white;" type="text" class="form-control" name="total_price" value="<?php echo get_field_value($item, 'total_price'); ?>" readonly>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Receiver Name</label>
                        <input style="color: #000000;" type="text" class="form-control" name="receiver_name" value="<?php echo get_field_value($item, 'receiver_name'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Teacher's ID</label>
                        <input style="color: #000000;" type="text" class="form-control" name="teacher_id" value="<?php echo get_field_value($item, 'teacher_id'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Position</label>
                        <input style="color: #000000;" type="text" class="form-control" name="position" value="<?php echo get_field_value($item, 'position'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Date Inspected</label>
                        <input style="color: #000000;" type="date" class="form-control" name="date_inspected" value="<?php echo get_field_value($item, 'date_inspected'); ?>">
                    </div>
                    <div class="col-md-5">
                        <label class="form-label">Inspection Team</label>
                        <input style="color: #000000;" type="text" class="form-control" name="inspectors" value="<?php echo get_field_value($item, 'inspectors'); ?>" placeholder="e.g., Joan Savage, Nelson British, Bles Sings">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Barangay Councilor</label>
                        <input style="color: #000000;" type="text" class="form-control" name="barangay_councilor" value="<?php echo get_field_value($item, 'barangay_councilor'); ?>">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">PTA Observer</label>
                        <input style="color: #000000;" type="text" class="form-control" name="pta_observer" value="<?php echo get_field_value($item, 'pta_observer'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date Received</label>
                        <input style="color: #000000;" type="date" class="form-control" name="date_received" value="<?php echo get_field_value($item, 'date_received'); ?>">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Property Custodian</label>
                        <input style="color: #000000;" type="text" class="form-control" name="property_custodian" value="<?php echo get_field_value($item, 'property_custodian'); ?>">
                    </div>
                </div>
              <?php endif; ?>

              <div class="text-end mt-3">
                <a href="track_inventory.php" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Update Record</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <?php require_once('partials/_mainfooter.php'); ?>
</div>
<?php require_once('partials/_scripts.php'); ?>

<script>
  function toggleDebug() {
    var debugInfo = document.getElementById('debugInfo');
    if (debugInfo.style.display === 'none') {
      debugInfo.style.display = 'block';
    } else {
      debugInfo.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Auto calculate total amount for all forms
    const calculateTotal = () => {
      console.log("Calculating total...");
      
      // For PAR (Property Acknowledgment Receipt)
      const parQuantity = document.querySelector('input[name="quantity"]');
      const parUnitCost = document.querySelector('input[name="unit_cost"]');
      const parTotalAmount = document.querySelector('input[name="total_amount"]');
      
      if (parQuantity && parUnitCost && parTotalAmount) {
        console.log("Found PAR fields");
        const calculateParTotal = () => {
          const quantity = parseFloat(parQuantity.value) || 0;
          const unitCost = parseFloat(parUnitCost.value) || 0;
          const total = quantity * unitCost;
          parTotalAmount.value = total.toFixed(2);
          console.log(`PAR calculation: ${quantity} * ${unitCost} = ${total}`);
        };
        
        parQuantity.addEventListener('input', calculateParTotal);
        parUnitCost.addEventListener('input', calculateParTotal);
        calculateParTotal(); // Initial calculation
      }
      
      // For IAR (Inspection and Acceptance Report)
      const iarQuantity = document.querySelector('input[name="quantity"]');
      const iarUnitPrice = document.querySelector('input[name="unit_price"]');
      const iarTotalPrice = document.querySelector('input[name="total_price"]');
      
      if (iarQuantity && iarUnitPrice && iarTotalPrice) {
        console.log("Found IAR fields");
        const calculateIarTotal = () => {
          const quantity = parseFloat(iarQuantity.value) || 0;
          const unitPrice = parseFloat(iarUnitPrice.value) || 0;
          const total = quantity * unitPrice;
          iarTotalPrice.value = total.toFixed(2);
          console.log(`IAR calculation: ${quantity} * ${unitPrice} = ${total}`);
        };
        
        iarQuantity.addEventListener('input', calculateIarTotal);
        iarUnitPrice.addEventListener('input', calculateIarTotal);
        calculateIarTotal(); // Initial calculation
      }
      
      // For RIS (Requisition and Issue Slip)
      const risRequestedQty = document.querySelector('input[name="requested_qty"]');
      const risUnitCost = document.querySelector('input[name="unit_cost"]');
      const risTotalCost = document.querySelector('input[name="total_cost"]');
      
      if (risRequestedQty && risUnitCost && risTotalCost) {
        console.log("Found RIS fields");
        const calculateRisTotal = () => {
          const quantity = parseFloat(risRequestedQty.value) || 0;
          const unitCost = parseFloat(risUnitCost.value) || 0;
          const total = quantity * unitCost;
          risTotalCost.value = total.toFixed(2);
          console.log(`RIS calculation: ${quantity} * ${unitCost} = ${total}`);
        };
        
        risRequestedQty.addEventListener('input', calculateRisTotal);
        risUnitCost.addEventListener('input', calculateRisTotal);
        calculateRisTotal(); // Initial calculation
      }
      
      // For ICS (Inventory Custodian Slip)
      const icsQuantity = document.querySelector('input[name="quantity"]');
      const icsUnitCost = document.querySelector('input[name="unit_cost"]');
      const icsTotalAmount = document.querySelector('input[name="total_amount"]');
      
      if (icsQuantity && icsUnitCost && icsTotalAmount) {
        console.log("Found ICS fields");
        const calculateIcsTotal = () => {
          const quantity = parseFloat(icsQuantity.value) || 0;
          const unitCost = parseFloat(icsUnitCost.value) || 0;
          const total = quantity * unitCost;
          icsTotalAmount.value = total.toFixed(2);
          console.log(`ICS calculation: ${quantity} * ${unitCost} = ${total}`);
        };
        
        icsQuantity.addEventListener('input', calculateIcsTotal);
        icsUnitCost.addEventListener('input', calculateIcsTotal);
        calculateIcsTotal(); // Initial calculation 
      }
    };
    
    // Call the calculation function
    calculateTotal();
  });
</script>
</body>
</html>


// how tracking 
<?php
session_start();
include('config/config.php');
include('config/checklogin.php');
check_login();

// Check for success message in URL
if (isset($_GET['success'])) {
  $success = $_GET['success'];
}

// Handle delete
if (isset($_GET['delete']) && isset($_GET['table']) && isset($_GET['item_id'])) {
  $id = $_GET['delete']; // This is the main record ID (iar_id, ics_id, etc.)
  $table = $_GET['table']; // The main table name
  $item_id = $_GET['item_id']; // This is the specific item ID (iar_item_id, ics_item_id, etc.)
  
  // Map tables to their items tables
  $item_tables = [
    'inspection_acceptance_reports' => 'iar_items',
    'inventory_custodian_slips' => 'ics_items',
    'requisition_and_issue_slips' => 'ris_items',
    'property_acknowledgment_receipts' => 'par_items'
  ];
  
  // Map item tables to their ID columns
  $item_id_columns = [
    'iar_items' => 'iar_item_id',
    'ics_items' => 'ics_item_id',
    'ris_items' => 'ris_item_id',
    'par_items' => 'par_item_id'
  ];
  
  // Get the correct items table and ID column
  $items_table = isset($item_tables[$table]) ? $item_tables[$table] : '';
  $item_id_column = isset($item_id_columns[$items_table]) ? $item_id_columns[$items_table] : '';
  
  if (!empty($items_table) && !empty($item_id_column)) {
    // Debug information
    error_log("Deleting from table: $items_table where $item_id_column = $item_id");
    
    // Delete the specific item record
    $adn = "DELETE FROM `$items_table` WHERE `$item_id_column` = ?";
    $stmt = $mysqli->prepare($adn);
    if ($stmt) {
      $stmt->bind_param('i', $item_id);
      $result = $stmt->execute();
      $stmt->close();
      if ($result) {
        $success = "Item deleted successfully";
        header("refresh:1; url=track_inventory.php");
      } else {
        $err = "Error deleting item: " . $mysqli->error;
        error_log("MySQL Error: " . $mysqli->error);
        // header("refresh:1; url=track_inventory.php");
      }
    } else {
      $err = "Error preparing delete statement: " . $mysqli->error;
      error_log("MySQL Prepare Error: " . $mysqli->error);
      // header("refresh:1; url=track_inventory.php");
    }
  } else {
    $err = "Invalid table or item table";
    header("refresh:1; url=track_inventory.php");
  }
}

// Check if a search item is submitted
$searchResults = [];
if (isset($_GET['item']) && !empty(trim($_GET['item']))) {
  $search = $mysqli->real_escape_string(trim($_GET['item']));
  
  // Search across all inventory tables
  $tables = [
    'inspection_acceptance_reports' => ['items_table' => 'iar_items', 'id_column' => 'iar_id', 'no_column' => 'iar_no'],
    'inventory_custodian_slips' => ['items_table' => 'ics_items', 'id_column' => 'ics_id', 'no_column' => 'ics_no'],
    'requisition_and_issue_slips' => ['items_table' => 'ris_items', 'id_column' => 'ris_id', 'no_column' => 'ris_no'],
    'property_acknowledgment_receipts' => ['items_table' => 'par_items', 'id_column' => 'par_id', 'no_column' => 'par_no']
  ];
  
  foreach ($tables as $table => $config) {
    $sql = "SELECT DISTINCT m.*, i.item_description, i.unit_cost, ii.quantity, ii.iar_item_id,
           (ii.quantity * i.unit_cost) as total_amount,
           '$table' as source_table 
           FROM `$table` m
           JOIN {$config['items_table']} ii ON m.{$config['id_column']} = ii.{$config['id_column']}
           JOIN items i ON ii.item_id = i.item_id
           WHERE i.item_description LIKE CONCAT('%', ?, '%')
           OR m.receiver_name LIKE CONCAT('%', ?, '%')
           OR m.end_user_name LIKE CONCAT('%', ?, '%')
           OR m.received_by_name LIKE CONCAT('%', ?, '%')";
    
    // Special handling for requisition_and_issue_slips
    if ($table == 'requisition_and_issue_slips') {
      $sql = "SELECT DISTINCT m.*, i.item_description, i.unit_cost, ii.issued_qty as quantity, ii.ris_item_id,
             (ii.issued_qty * i.unit_cost) as total_amount,
             '$table' as source_table 
             FROM `$table` m
             JOIN {$config['items_table']} ii ON m.{$config['id_column']} = ii.{$config['id_column']}
             JOIN items i ON ii.item_id = i.item_id
             WHERE i.item_description LIKE CONCAT('%', ?, '%')
             OR m.receiver_name LIKE CONCAT('%', ?, '%')
             OR m.end_user_name LIKE CONCAT('%', ?, '%')
             OR m.received_by_name LIKE CONCAT('%', ?, '%')";
    }
    
    $stmt = $mysqli->prepare($sql);
    if ($stmt) {
      $stmt->bind_param('ssss', $search, $search, $search, $search);
      $stmt->execute();
      $result = $stmt->get_result();
      
      if ($result) {
        while ($row = $result->fetch_object()) {
          $searchResults[] = $row;
        }
      }
      $stmt->close();
    }
  }
}

require_once('partials/_head.php');
?>

<body>
  <!-- Sidenav -->
  <?php
  require_once('partials/_sidebar.php');
  ?>
  <!-- Main content -->
  <div class="main-content">
    <!-- Top navbar -->
    <?php
    require_once('partials/_topnav.php');
    ?>
    <!-- Header -->
    <div style="background-image: url(assets/img/theme/bnhsfront.jpg); background-size: cover;"
      class="header  pb-8 pt-5 pt-md-8">
      <span class="mask bg-gradient-dark opacity-8"></span>
      <div class="container-fluid">
        <div class="header-body">
        </div>
      </div>
    </div>
    <!-- Page content -->
    <div class="container-fluid mt--8">
      <!-- Table -->
      <div class="row">
        <div class="col">
          <div class="card shadow">
            <div class="card-header border-0">
              <form class="form-inline" method="GET" style="color: black; float: left; margin-top: 20px; margin-bottom: 20px;">
                <input id="search" class="form-control mr-sm-2" style="width: 500px; color: black;" type="search" name="item"
                  placeholder="Search by Item Description or End User" aria-label="Search"
                  value="<?php echo isset($_GET['item']) ? htmlspecialchars($_GET['item']) : ''; ?>">
              </form>
            </div>
            <div class="table-responsive">
              <table class="table align-items-center table-flush">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Source</th>
                    <th scope="col">Item Description</th>
                    <th scope="col">Item No.</th>
                    <th scope="col">End User</th>
                    <th scope="col">Date</th>
                    <th scope="col">Unit Cost</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Total Cost</th>
                    <th scope="col">Custodian</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody class="list" id="userTableBody">
                  <?php
                  if (!empty($searchResults)) {
                    foreach ($searchResults as $item) {
                  ?>
                      <tr>
                        <td><?php echo ucfirst(str_replace('_', ' ', $item->source_table)); ?></td>
                        <td><?php echo $item->item_description ?? 'N/A'; ?></td>
                        <td><?php echo $item->{$item->source_table . '_no'} ?? 'N/A'; ?></td>
                        <td><?php echo $item->receiver_name ?? $item->end_user_name ?? $item->received_by_name ?? 'N/A'; ?></td>
                        <td><?php echo $item->created_at ?? 'N/A'; ?></td>
                        <td><?php echo $item->unit_cost ?? '0.00'; ?></td>
                        <td><?php echo $item->quantity ?? '0'; ?></td>
                        <td><?php echo $item->total_amount ?? '0.00'; ?></td>
                        <td><?php echo $item->property_custodian ?? $item->custodian_name ?? $item->issued_by_name ?? 'N/A'; ?></td>
                        <td>
                          <a href="track_view.php?id=<?php echo $item->{$tables[$item->source_table]['id_column']}; ?>&table=<?php echo $item->source_table; ?>">
                            <button class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</button>
                          </a>
                          <a href="track_inventory.php?delete=<?php echo $item->{$tables[$item->source_table]['id_column']}; ?>&table=<?php echo $item->source_table; ?>&item_id=<?php 
                            // Get the items table item ID
                            $items_table = $tables[$item->source_table]['items_table'];
                            $item_id_field = "{$items_table}_id";
                            if ($item->source_table == 'requisition_and_issue_slips' && $items_table == 'ris_items') {
                                $item_id_field = "ris_item_id";
                            }elseif($item->source_table == 'property_acknowledgment_receipts' && $items_table == 'par_items'){
                              $item_id_field = "par_item_id";
                            }elseif($item->source_table == 'inventory_custodian_slips' && $items_table == 'ics_items'){
                              $item_id_field = "ics_item_id";
                            }elseif($item->source_table == 'inspection_acceptance_reports' && $items_table == 'iar_items'){
                              $item_id_field = "iar_item_id";
                            }

                            // Debug the field name
                            error_log("Looking for field: $item_id_field in item object");
                            echo isset($item->$item_id_field) ? $item->$item_id_field : '0';
                          ?>"
                            onclick="return confirm('Are you sure you want to delete this record?')">
                            <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Delete</button>
                          </a>
                          <a href="track_inventory_update.php?id=<?php echo $item->{$tables[$item->source_table]['id_column']}; ?>&table=<?php echo $item->source_table; ?>">
                            <button class="btn btn-sm btn-primary"><i class="fas fa-user-edit"></i> Update</button>
                          </a>
                        </td>
                      </tr>
                      <?php
                    }
                  } else {
                    // Display all inventory items if no search query
                    $tables = [
                      'inspection_acceptance_reports' => ['items_table' => 'iar_items', 'id_column' => 'iar_id', 'no_column' => 'iar_no'],
                      'inventory_custodian_slips' => ['items_table' => 'ics_items', 'id_column' => 'ics_id', 'no_column' => 'ics_no'],
                      'requisition_and_issue_slips' => ['items_table' => 'ris_items', 'id_column' => 'ris_id', 'no_column' => 'ris_no'],
                      'property_acknowledgment_receipts' => ['items_table' => 'par_items', 'id_column' => 'par_id', 'no_column' => 'par_no']
                    ];

                    foreach ($tables as $table => $config) {
                      $sql = "SELECT DISTINCT m.*, i.item_description, i.unit_cost, ii.quantity, ii.iar_item_id,
                             (ii.quantity * i.unit_cost) as total_amount,
                             '$table' as source_table
                             FROM `$table` m
                             JOIN {$config['items_table']} ii ON m.{$config['id_column']} = ii.{$config['id_column']}
                             JOIN items i ON ii.item_id = i.item_id
                             ORDER BY m.created_at DESC";

                      // Make special adjustment for the requisition_and_issue_slips table
                      if ($table == 'requisition_and_issue_slips') {
                        $sql = "SELECT DISTINCT m.*, i.item_description, i.unit_cost, ii.issued_qty as quantity, ii.ris_item_id,
                              (ii.issued_qty * i.unit_cost) as total_amount,
                              '$table' as source_table
                              FROM `$table` m
                              JOIN {$config['items_table']} ii ON m.{$config['id_column']} = ii.{$config['id_column']}
                              JOIN items i ON ii.item_id = i.item_id
                              ORDER BY m.created_at DESC";
                      }
                      elseif ($table == 'inventory_custodian_slips') {
                        $sql = "SELECT DISTINCT m.*, i.item_description, i.unit_cost, ii.quantity, ii.ics_item_id,
                              (ii.quantity * i.unit_cost) as total_amount,
                              '$table' as source_table
                              FROM `$table` m
                              JOIN {$config['items_table']} ii ON m.{$config['id_column']} = ii.{$config['id_column']}
                              JOIN items i ON ii.item_id = i.item_id
                              ORDER BY m.created_at DESC";
                      }
                      elseif ($table == 'property_acknowledgment_receipts') {
                        $sql = "SELECT DISTINCT m.*, i.item_description, i.unit_cost, ii.quantity, ii.par_item_id,
                              (ii.quantity * i.unit_cost) as total_amount,
                              '$table' as source_table
                              FROM `$table` m
                              JOIN {$config['items_table']} ii ON m.{$config['id_column']} = ii.{$config['id_column']}
                              JOIN items i ON ii.item_id = i.item_id
                              ORDER BY m.created_at DESC";
                      }

                      // Add debugging
                      error_log("Executing query for table $table: " . $sql);

                      $stmt = $mysqli->prepare($sql);
                      if ($stmt) {
                        $stmt->execute();
                        $result = $stmt->get_result();

                        // Add debugging
                        error_log("Query for $table returned " . ($result ? $result->num_rows : 0) . " rows");

                        if ($result && $result->num_rows > 0) {
                          while ($item = $result->fetch_object()) {
                      ?>
                            <tr>
                              <td><?php echo ucfirst(str_replace('_', ' ', $table)); ?></td>
                              <td><?php echo $item->item_description ?? 'N/A'; ?></td>
                              <td><?php echo $item->{$config['no_column']} ?? 'N/A'; ?></td>
                              <td><?php echo $item->receiver_name ?? $item->end_user_name ?? $item->received_by_name ?? 'N/A'; ?></td>
                              <td><?php echo $item->created_at ?? 'N/A'; ?></td>
                              <td><?php echo $item->unit_cost ?? '0.00'; ?></td>
                              <td><?php echo $item->quantity ?? '0'; ?></td>
                              <td><?php echo $item->total_amount ?? '0.00'; ?></td>
                              <td><?php echo $item->property_custodian ?? $item->custodian_name ?? $item->issued_by_name ?? 'N/A'; ?></td>
                              <td>
                                <a href="track_view.php?id=<?php echo $item->{$config['id_column']}; ?>&table=<?php echo $table; ?>">
                                  <button class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</button>
                                </a>
                                <a href="track_inventory.php?delete=<?php echo $item->{$config['id_column']}; ?>&table=<?php echo $table; ?>&item_id=<?php 
                                  // Get the items table item ID
                                  $items_table = $config['items_table'];
                                  $item_id_field = "{$items_table}_id";
                                  if ($table == 'requisition_and_issue_slips' && $items_table == 'ris_items') {
                                      $item_id_field = "ris_item_id";
                                  }elseif($table == 'property_acknowledgment_receipts' && $items_table == 'par_items'){
                                      $item_id_field = "par_item_id";
                                  }elseif($table == 'inventory_custodian_slips' && $items_table == 'ics_items'){
                                      $item_id_field = "ics_item_id";
                                  }elseif($table == 'inspection_acceptance_reports' && $items_table == 'iar_items'){
                                      $item_id_field = "iar_item_id";
                                  }
                                  // Debug the field name
                                  error_log("Looking for field: $item_id_field in item object");
                                  echo isset($item->$item_id_field) ? $item->$item_id_field : '0';
                                ?>"
                                  onclick="return confirm('Are you sure you want to delete this record?')">
                                  <button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Delete</button>
                                </a>
                                <a href="track_inventory_update.php?id=<?php echo $item->{$config['id_column']}; ?>&table=<?php echo $table; ?>">
                                  <button class="btn btn-sm btn-primary"><i class="fas fa-user-edit"></i> Update</button>
                                </a>
                              </td>
                            </tr>
                  <?php
                          }
                        }
                        $stmt->close();
                      }
                    }
                  }
                  ?>
                  <tr id="noResults" style="display: none;">
                    <td colspan="10" class="text-center">No inventory items found.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- Footer -->
      <?php
      require_once('partials/_mainfooter.php');
      ?>
    </div>
  </div>
  <!-- Argon Scripts -->
  <?php
  require_once('partials/_scripts.php');
  ?>
</body>

</html>
<td class="tds">
                   ₱<?php echo number_format($item->total_price ?? 0, 2); ?>
                </td>
              </tr>
              <tr>
              <td class="tds" ></td>
              <td class="tds" ></td>
              <td class="tds" ></td>
              <td class="tds" ></td>
            </tr>



            <?php
session_start();
include('config/config.php');
include('config/checklogin.php');
check_login();

if ($_SERVER['REQUEST_METHOD'] == "POST") {
  // Sanitize and collect form data
  function sanitize($data)
  {
    return htmlspecialchars(trim($data));
  }

  $entity_name = sanitize($_POST['entity_name']);
  $fund_cluster = sanitize($_POST['fund_cluster']);
  $supplier_name = sanitize($_POST['supplier']);
  $po_no_date = sanitize($_POST['po_no_date']);
  $req_office = sanitize($_POST['req_office']);
  $responsibility_center = sanitize($_POST['responsibility_center']);
  $iar_no = sanitize($_POST['iar_no']);
  $iar_date = sanitize($_POST['iar_date']);
  $invoice_no_date = sanitize($_POST['invoice_no_date']);
  $stock_no = isset($_POST['stock_no']) ? (is_array($_POST['stock_no']) ? $_POST['stock_no'] : array($_POST['stock_no'])) : array();
  $remarks = isset($_POST['remarks']) ? (is_array($_POST['remarks']) ? $_POST['remarks'] : array($_POST['remarks'])) : array();
  $item_description = isset($_POST['item_description']) ? (is_array($_POST['item_description']) ? $_POST['item_description'] : array($_POST['item_description'])) : array();
  $unit = isset($_POST['unit']) ? (is_array($_POST['unit']) ? $_POST['unit'] : array($_POST['unit'])) : array();
  $quantity = isset($_POST['quantity']) ? (is_array($_POST['quantity']) ? $_POST['quantity'] : array($_POST['quantity'])) : array();
  $unit_price = isset($_POST['unit_price']) ? (is_array($_POST['unit_price']) ? $_POST['unit_price'] : array($_POST['unit_price'])) : array();
  $total_price = isset($_POST['total_price']) ? (is_array($_POST['total_price']) ? $_POST['total_price'] : array($_POST['total_price'])) : array();
  $item_id = isset($_POST['item_id']) ? (is_array($_POST['item_id']) ? $_POST['item_id'] : array($_POST['item_id'])) : array();
  $iar_item_id = isset($_POST['iar_item_id']) ? (is_array($_POST['iar_item_id']) ? $_POST['iar_item_id'] : array($_POST['iar_item_id'])) : array();

  $receiver_name = sanitize($_POST['receiver_name']);
  $teacher_id = sanitize($_POST['teacher_id']);
  $position = sanitize($_POST['position']);
  $date_inspected = sanitize($_POST['date_inspected']);
  $inspectors = sanitize($_POST['inspectors']);
  $barangay_councilor = sanitize($_POST['barangay_councilor']);
  $pta_observer = sanitize($_POST['pta_observer']);
  $date_received = sanitize($_POST['date_received']);
  $property_custodian = sanitize($_POST['property_custodian']);

  // Check if we're updating an IAR
  if (isset($_GET['update'])) {
    $update = $_GET['update'];

    // Start transaction
    $mysqli->begin_transaction();

    try {
      // First, get or create entity
      $stmt = $mysqli->prepare("SELECT entity_id FROM entities WHERE entity_name = ? AND fund_cluster = ?");
      $stmt->bind_param("ss", $entity_name, $fund_cluster);
      $stmt->execute();
      $result = $stmt->get_result();

      if ($result->num_rows > 0) {
        $entity_id = $result->fetch_object()->entity_id;
      } else {
        $stmt = $mysqli->prepare("INSERT INTO entities (entity_name, fund_cluster) VALUES (?, ?)");
        $stmt->bind_param("ss", $entity_name, $fund_cluster);
        $stmt->execute();
        $entity_id = $mysqli->insert_id;
      }

      // Get or create supplier
      $stmt = $mysqli->prepare("SELECT supplier_id FROM suppliers WHERE supplier_name = ?");
      $stmt->bind_param("s", $supplier_name);
      $stmt->execute();
      $result = $stmt->get_result();

      if ($result->num_rows > 0) {
        $supplier_id = $result->fetch_object()->supplier_id;
      } else {
        $stmt = $mysqli->prepare("INSERT INTO suppliers (supplier_name) VALUES (?)");
        $stmt->bind_param("s", $supplier_name);
        $stmt->execute();
        $supplier_id = $mysqli->insert_id;
      }

      // Update inspection_acceptance_reports
      $stmt = $mysqli->prepare("UPDATE inspection_acceptance_reports SET 
        entity_id = ?, supplier_id = ?, iar_no = ?, po_no_date = ?, req_office = ?, 
        responsibility_center = ?, iar_date = ?, invoice_no_date = ?, 
        receiver_name = ?, teacher_id = ?, position = ?, date_inspected = ?, 
        inspectors = ?, barangay_councilor = ?, pta_observer = ?, date_received = ?, 
        property_custodian = ?
        WHERE iar_id = ?");

      $stmt->bind_param(
        "iisssssssssssssssi",
        $entity_id,
        $supplier_id,
        $iar_no,
        $po_no_date,
        $req_office,
        $responsibility_center,
        $iar_date,
        $invoice_no_date,
        $receiver_name,
        $teacher_id,
        $position,
        $date_inspected,
        $inspectors,
        $barangay_councilor,
        $pta_observer,
        $date_received,
        $property_custodian,
        $update
      );

      if (!$stmt->execute()) {
        throw new Exception("Error updating IAR: " . $stmt->error);
      }

      // Update each item
      for ($i = 0; $i < count($item_id); $i++) {
        // Calculate total price
        $qty = (int)$quantity[$i];
        $price = (float)$unit_price[$i];
        $total = $qty * $price;

        // Update items table
        $stmt = $mysqli->prepare("UPDATE items SET 
          stock_no = ?, item_description = ?, unit = ?, unit_cost = ?
          WHERE item_id = ?");

        $stmt->bind_param("sssdi", $stock_no[$i], $item_description[$i], $unit[$i], $unit_price[$i], $item_id[$i]);

        if (!$stmt->execute()) {
          throw new Exception("Error updating item: " . $stmt->error);
        }

        // Update iar_items
        $stmt = $mysqli->prepare("UPDATE iar_items SET 
          quantity = ?, unit_price = ?, total_price = ?, remarks = ?
          WHERE iar_item_id = ?");

        $stmt->bind_param("iddsi", $qty, $price, $total, $remarks[$i], $iar_item_id[$i]);

        if (!$stmt->execute()) {
          throw new Exception("Error updating IAR items: " . $stmt->error);
        }
      }

      // Commit transaction
      $mysqli->commit();
      $success = "Inspection and Acceptance Report Updated Successfully";
      header("refresh:1; url=display_iar.php");
    } catch (Exception $e) {
      // Rollback transaction on error
      $mysqli->rollback();
      $err = "Error: " . $e->getMessage();
      header("refresh:1; url=display_iar.php");
    }
  }
}

require_once('partials/_head.php');
?>

<body>
  <!-- Sidenav -->
  <?php require_once('partials/_sidebar.php'); ?>

  <!-- Main content -->
  <div class="main-content">
    <!-- Top navbar -->
    <?php require_once('partials/_topnav.php'); ?>

    <?php
    if (isset($_GET['update'])) {
      $update = $_GET['update'];

      // First get the basic IAR info
      $iar_query = "SELECT 
        iar.*, 
        e.entity_name, 
        e.fund_cluster, 
        s.supplier_name as supplier
      FROM inspection_acceptance_reports iar
      JOIN entities e ON iar.entity_id = e.entity_id
      JOIN suppliers s ON iar.supplier_id = s.supplier_id
      WHERE iar.iar_id = ?";

      $stmt = $mysqli->prepare($iar_query);
      $stmt->bind_param("i", $update);
      $stmt->execute();
      $iar_result = $stmt->get_result();
      $iar_info = $iar_result->fetch_object();

      // Then get all items for this IAR
      $items_query = "SELECT 
        i.item_id,
        i.stock_no,
        i.item_description,
        i.unit,
        i.unit_cost as unit_price,
        ii.iar_item_id,
        ii.quantity,
        ii.unit_price as item_unit_price,
        ii.total_price,
        ii.remarks
      FROM iar_items ii
      JOIN items i ON ii.item_id = i.item_id
      WHERE ii.iar_id = ?";

      $stmt = $mysqli->prepare($items_query);
      $stmt->bind_param("i", $update);
      $stmt->execute();
      $items_result = $stmt->get_result();
      $iar_items = $items_result->fetch_all(MYSQLI_ASSOC);
    }
    ?>

    <!-- Header -->
    <div style="background-image: url(assets/img/theme/bnhsfront.jpg); background-size: cover;" class="header pb-8 pt-5 pt-md-8">
      <span class="mask bg-gradient-dark opacity-8"></span>
    </div>

    <!-- Page content -->
    <div class="container-fluid mt--8">
      <div class="row">
        <div class="col">
          <div class="card shadow">
            <div class="card-body">

              <form method="POST" action="<?php echo htmlspecialchars($_SERVER['REQUEST_URI']); ?>" class="border border-light p-4 rounded">
                <div class="container mt-4">
                  <h2 class="text-center mb-4 text-uppercase"> Update Inspection and Acceptance Report</h2>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">Entity Name</label>
                      <input style="color: #000000;" type="text" class="form-control" name="entity_name" value="<?php echo htmlspecialchars($iar_info->entity_name); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Fund Cluster</label>
                      <input style="color: #000000;" type="text" class="form-control" name="fund_cluster" value="<?php echo htmlspecialchars($iar_info->fund_cluster); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Supplier</label>
                      <input style="color: #000000;" type="text" class="form-control" name="supplier" value="<?php echo htmlspecialchars($iar_info->supplier); ?>" readonly>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">PO No. / Date</label>
                      <input style="color: #000000;" type="text" class="form-control" name="po_no_date" value="<?php echo htmlspecialchars($iar_info->po_no_date); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Requisitioning Office/Dept.</label>
                      <input style="color: #000000;" type="text" class="form-control" name="req_office" value="<?php echo htmlspecialchars($iar_info->req_office); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Responsibility Center</label>
                      <input style="color: #000000;" type="text" class="form-control" name="responsibility_center" value="<?php echo htmlspecialchars($iar_info->responsibility_center); ?>" readonly>
                    </div>

                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">IAR No.</label>
                      <input style="color: #000000;" type="text" class="form-control" name="iar_no" value="<?php echo htmlspecialchars($iar_info->iar_no); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">IAR Date</label>
                      <input style="color: #000000;" type="date" class="form-control" name="iar_date" value="<?php echo $iar_info->iar_date; ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Invoice No. / Date</label>
                      <input style="color: #000000;" type="text" class="form-control" name="invoice_no_date" value="<?php echo htmlspecialchars($iar_info->invoice_no_date); ?>" readonly>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">Receiver Name</label>
                      <input style="color: #000000;" type="text" class="form-control" name="receiver_name" value="<?php echo htmlspecialchars($iar_info->receiver_name); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Teacher's ID</label>
                      <input style="color: #000000;" type="text" class="form-control" name="teacher_id" value="<?php echo htmlspecialchars($iar_info->teacher_id); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Position</label>
                      <input style="color: #000000;" type="text" class="form-control" name="position" value="<?php echo htmlspecialchars($iar_info->position); ?>" readonly>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">Date Inspected</label>
                      <input style="color: #000000;" type="date" class="form-control" name="date_inspected" value="<?php echo $iar_info->date_inspected; ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Inspection Team (comma separated)</label>
                      <input style="color: #000000;" type="text" class="form-control" name="inspectors" value="<?php echo htmlspecialchars($iar_info->inspectors); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Barangay Councilor</label>
                      <input style="color: #000000;" type="text" class="form-control" name="barangay_councilor" value="<?php echo htmlspecialchars($iar_info->barangay_councilor); ?>" readonly>
                    </div>
                  </div>

                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label class="form-label">PTA Observer</label>
                      <input style="color: #000000;" type="text" class="form-control" name="pta_observer" value="<?php echo htmlspecialchars($iar_info->pta_observer); ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Date Received</label>
                      <input style="color: #000000;" type="date" class="form-control" name="date_received" value="<?php echo $iar_info->date_received; ?>" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Property Custodian</label>
                      <input style="color: #000000;" type="text" class="form-control" name="property_custodian" value="<?php echo htmlspecialchars($iar_info->property_custodian); ?>" readonly>
                    </div>
                  </div>

                  <div style="margin-bottom: 20px;"><strong>Edit Items:</strong></div>

                  <?php foreach ($iar_items as $index => $item): ?>
                    <div class="card mb-4">
                      <div class="card-header bg-light">
                        <h5>Item #<?php echo $index + 1; ?></h5>
                      </div>
                      <div class="card-body">
                        <input type="hidden" name="item_id[]" value="<?php echo $item['item_id']; ?>">
                        <input type="hidden" name="iar_item_id[]" value="<?php echo $item['iar_item_id']; ?>">

                        <div class="row mb-3">
                          <div class="col-md-4">
                            <label class="form-label">Stock / Property No.</label>
                            <input style="color: #000000;" type="text" class="form-control" name="stock_no[]" value="<?php echo htmlspecialchars($item['stock_no']); ?>">
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Item Description</label>
                            <input style="color: #000000;" type="text" class="form-control" name="item_description[]" value="<?php echo htmlspecialchars($item['item_description']); ?>">
                          </div>
                          <div class="col-md-2">
                            <label class="form-label">Unit</label>
                            <select style="color: #000000;" class="form-control" name="unit[]">
                              <option value="">Select Unit</option>
                              <option value="box" <?php echo ($item['unit'] == 'box') ? 'selected' : ''; ?>>box</option>
                              <option value="pieces" <?php echo ($item['unit'] == 'pieces') ? 'selected' : ''; ?>>pieces</option>
                            </select>
                          </div>
                          <div class="col-md-2">
                            <label class="form-label">Qty</label>
                            <input style="color: #000000;" type="number" class="form-control quantity" name="quantity[]" value="<?php echo $item['quantity']; ?>">
                          </div>
                        </div>

                        <div class="row mb-3">
                          <div class="col-md-4">
                            <label class="form-label">Unit Price</label>
                            <input style="color: #000000;" type="number" step="0.01" class="form-control unit-price" name="unit_price[]" value="<?php echo $item['unit_price']; ?>">
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Total Price</label>
                            <input style="color: #000000;" type="text" class="form-control total-price" name="total_price[]" value="<?php echo number_format($item['total_price'], 2); ?>" readonly>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Remarks</label>
                            <select style="color: #000000;" class="form-control" name="remarks[]">
                              <option value="">Select Remarks</option>
                              <option value="Consumable" <?php echo ($item['remarks'] == 'Consumable') ? 'selected' : ''; ?>>Consumable</option>
                              <option value="Non-consumable" <?php echo ($item['remarks'] == 'Non-consumable') ? 'selected' : ''; ?>>Non-consumable</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">Update Item</button>
                      </div>
                    </div>
                  <?php endforeach; ?>

                  <div class="text-end mt-3">
                    <a href="display_iar.php">
                    <button type="submit" class="btn btn-primary">Back</button>
                    </a>
                   
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <?php require_once('partials/_mainfooter.php'); ?>
    </div>
  </div>

  <!-- Argon Scripts -->
  <?php require_once('partials/_scripts.php'); ?>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Add event listeners for all quantity and unit price inputs
      const forms = document.querySelectorAll('form');

      forms.forEach(form => {
        const qtyInputs = form.querySelectorAll('.quantity');
        const priceInputs = form.querySelectorAll('.unit-price');
        const totalInputs = form.querySelectorAll('.total-price');

        // Function to update total price
        function updateTotal(index) {
          const qty = parseFloat(qtyInputs[index].value) || 0;
          const price = parseFloat(priceInputs[index].value) || 0;
          totalInputs[index].value = (qty * price).toFixed(2);
        }

        // Add event listeners to all quantity and price inputs
        qtyInputs.forEach((input, index) => {
          input.addEventListener('input', () => updateTotal(index));
        });

        priceInputs.forEach((input, index) => {
          input.addEventListener('input', () => updateTotal(index));
        });

        // Initialize all totals
        for (let i = 0; i < qtyInputs.length; i++) {
          updateTotal(i);
        }
      });
    });
  </script>
</body>

</html>
<?php
session_start();
include('config/config.php');
include('config/checklogin.php');
check_login();

//Delete individual item
if (isset($_GET['delete_item'])) {
  $ics_item_id = $_GET['delete_item'];
  
  // Start transaction
  $mysqli->begin_transaction();
  
  try {
    // First get the item_id from ics_items
    $stmt = $mysqli->prepare("SELECT item_id FROM ics_items WHERE ics_item_id = ?");
    $stmt->bind_param('i', $ics_item_id);
    $stmt->execute();
    $result = $stmt->get_result();
    $item_id = $result->fetch_object()->item_id;
    
    // Delete from ics_items
    $stmt = $mysqli->prepare("DELETE FROM ics_items WHERE ics_item_id = ?");
    $stmt->bind_param('i', $ics_item_id);
    $stmt->execute();
    
    // Delete from items
    $stmt = $mysqli->prepare("DELETE FROM items WHERE item_id = ?");
    $stmt->bind_param('i', $item_id);
    $stmt->execute();
    
    // Commit transaction
    $mysqli->commit();
    $success = "Item Deleted Successfully";
    header("refresh:1; url=display_ics.php");
  } catch (Exception $e) {
    // Rollback transaction on error
    $mysqli->rollback();
    $err = "Error: " . $e->getMessage();
    header("refresh:1; url=display_ics.php");
  }
}

//Delete ICS
if (isset($_GET['delete'])) {
  $id = $_GET['delete'];
  
  // Start transaction
  $mysqli->begin_transaction();
  
  try {
    // Get all item_ids from ics_items for this ICS
    $stmt = $mysqli->prepare("SELECT item_id FROM ics_items WHERE ics_id = ?");
    $stmt->bind_param('i', $id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    // Delete from ics_items first
    $stmt = $mysqli->prepare("DELETE FROM ics_items WHERE ics_id = ?");
    $stmt->bind_param('i', $id);
    $stmt->execute();
    
    // Delete corresponding items
    while ($row = $result->fetch_object()) {
      $stmt = $mysqli->prepare("DELETE FROM items WHERE item_id = ?");
      $stmt->bind_param('i', $row->item_id);
      $stmt->execute();
    }
    
    // Delete from inventory_custodian_slips
    $stmt = $mysqli->prepare("DELETE FROM inventory_custodian_slips WHERE ics_id = ?");
    $stmt->bind_param('i', $id);
    $stmt->execute();
    
    // Commit transaction
    $mysqli->commit();
    $success = "Record Deleted Successfully";
    header("refresh:1; url=display_ics.php");
  } catch (Exception $e) {
    // Rollback transaction on error
    $mysqli->rollback();
    $err = "Error: " . $e->getMessage();
    header("refresh:1; url=display_ics.php");
  }
}

require_once('partials/_head.php');
?>

<body>
  <!-- Sidenav -->
  <?php require_once('partials/_sidebar.php'); ?>
  
  <!-- Main content -->
  <div class="main-content">
    <!-- Top navbar -->
    <?php require_once('partials/_topnav.php'); ?>
    
    <!-- Header -->
    <div style="background-image: url(assets/img/theme/bnhsfront.jpg); background-size: cover;" class="header pb-8 pt-5 pt-md-8">
      <span class="mask bg-gradient-dark opacity-8"></span>
      <div class="container-fluid">
        <div class="header-body"></div>
      </div>
    </div>
    
    <!-- Page content -->
    <div class="container-fluid mt--8">
      <!-- Table -->
      <div class="row">
        <div class="col">
          <div class="card shadow">
            <div class="card-header border-0">
              <div class="col">
                <h2 class="text-center mb-3 pt-3 text-uppercase">Inventory Custodian Slip</h2>
              </div>
              <!-- <div class="col text-right">
                <a href="print_ics_files.php" class="btn btn-sm btn-primary" target="_blank">
                  <i class="fas fa-print"></i> Print files
                </a>
              </div> -->
            </div>
            <div class="table-responsive">
              <table class="table align-items-center table-flush">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Entity Name</th>
                    <th scope="col">Fund Cluster</th>
                    <!-- <th scope="col">Article</th> -->
                    <th scope="col">ICS No.</th>
                    <!-- <th scope="col">Quantity</th> -->
                    <!-- <th scope="col">Unit</th> -->
                    <!-- <th scope="col">Unit Cost</th> -->
                    <!-- <th scope="col">Total Amount</th> -->
                    <!-- <th scope="col">Item Description</th> -->
                    <!-- <th scope="col">Inventory Item No.</th> -->
                    <!-- <th scope="col">Estimated Useful Life</th> -->
                    <th scope="col">User Name</th>
                    <th scope="col">Position/Office</th>
                    <th scope="col">Date Received(by User)</th>
                    <th scope="col">Property Custodian</th>
                    <th scope="col">Position/Office</th>
                    <th scope="col">Date Received(by Custodian)</th>
                    <!-- <th scope="col">Remarks</th> -->
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <?php
                  $ret = "SELECT ics.ics_id, e.entity_name, e.fund_cluster, ics.ics_no,
                           ics.end_user_name, ics.end_user_position, ics.end_user_date,
                           ics.custodian_name, ics.custodian_position, ics.custodian_date
                         FROM inventory_custodian_slips ics
                         JOIN entities e ON ics.entity_id = e.entity_id
                         GROUP BY ics.ics_no
                         ORDER BY ics.created_at DESC";
                  $stmt = $mysqli->prepare($ret);
                  if ($stmt === false) {
                    die("Error preparing statement: " . $mysqli->error);
                  }
                  if (!$stmt->execute()) {
                    die("Error executing statement: " . $stmt->error);
                  }
                  $res = $stmt->get_result();
                  while ($ics = $res->fetch_object()) {
                    // Get one item from this ICS to display as an example
                    $item_query = "SELECT ii.ics_item_id, i.item_id, ii.quantity, i.unit, 
                                    i.unit_cost, (ii.quantity * i.unit_cost) as total_amount,
                                    i.item_description, ii.inventory_item_no, i.estimated_useful_life,
                                    ii.remarks
                                  FROM ics_items ii
                                  JOIN items i ON ii.item_id = i.item_id
                                  WHERE ii.ics_id = ?
                                  LIMIT 1";
                    $item_stmt = $mysqli->prepare($item_query);
                    if ($item_stmt === false) {
                      echo "Error preparing item statement: " . $mysqli->error;
                      continue;
                    }
                    $item_stmt->bind_param('i', $ics->ics_id);
                    if (!$item_stmt->execute()) {
                      echo "Error executing item statement: " . $item_stmt->error;
                      continue;
                    }
                    $item_res = $item_stmt->get_result();
                    $item = $item_res->fetch_object();
                    ?>
                    <tr>
                      <td><?php echo htmlspecialchars($ics->entity_name); ?></td>
                      <td><?php echo htmlspecialchars($ics->fund_cluster); ?></td>
                      <!-- <td><?php echo htmlspecialchars($item->article); ?></td> -->
                      <td><?php echo htmlspecialchars($ics->ics_no); ?></td>
                      <!-- <td><?php echo number_format($item->quantity); ?></td> -->
                      <!-- <td><?php echo htmlspecialchars($item->unit); ?></td>
                      <td>₱<?php echo number_format($item->unit_cost, 2); ?></td>
                      <td>₱<?php echo number_format($item->total_amount, 2); ?></td>
                      <td><?php echo htmlspecialchars($item->item_description); ?></td>
                      <td><?php echo htmlspecialchars($item->inventory_item_no); ?></td>
                      <td><?php echo htmlspecialchars($item->estimated_useful_life); ?></td> -->
                      <td><?php echo htmlspecialchars($ics->end_user_name); ?></td>
                      <td><?php echo htmlspecialchars($ics->end_user_position); ?></td>
                      <td><?php echo date('M d, Y g:i A', strtotime($ics->end_user_date)); ?></td>
                      <td><?php echo htmlspecialchars($ics->custodian_name); ?></td>
                      <td><?php echo htmlspecialchars($ics->custodian_position); ?></td>
                      <td><?php echo date('M d, Y g:i A', strtotime($ics->custodian_date)); ?></td>
                      <!-- <td><?php echo htmlspecialchars($item->remarks); ?></td> -->
                      <td>
                        <!-- <a href="display_ics.php?delete=<?php echo $ics->ics_id; ?>">
                          <button class="btn btn-sm btn-danger">
                            <i class="fas fa-trash"></i>
                            Delete All
                          </button>
                        </a> -->

                        <a href="ics_update.php?update=<?php echo $ics->ics_id; ?>">
                          <button class="btn btn-sm btn-primary">
                            <i class="fas fa-user-edit"></i>
                            Update
                          </button>
                        </a>
                        <a href="print_ics_files.php?ics_id=<?php echo $ics->ics_id; ?>" target="_blank">
                          <button class="btn btn-sm btn-info">
                            <i class="fas fa-print"></i>
                            Print File
                          </button>
                        </a>
                      </td>
                    </tr>
                  <?php } ?>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <?php require_once('partials/_mainfooter.php'); ?>
    </div>
  </div>
  
  <!-- Argon Scripts -->
  <?php require_once('partials/_scripts.php'); ?>
  
  <style>
    /* .table-responsive {
      max-height: 500px;
      overflow-y: auto;
    } */
    .btn-group {
      display: flex;
      gap: 5px;
    }
    tbody tr:hover {
      background-color: #f8f9fa;
    }
  </style>
</body>
</html>